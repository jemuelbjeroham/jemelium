#!/bin/bash

# Environment variables
CONTROL_M_SERVER="rsTEST2"
EMAIL_RECIPIENT="iammsprakash@gmail.com"

# Function to fetch unavailable agents
fetch_unavailable_agents() {
    # Command to get agents - adjust as needed for your CLI environment
    AGENTS_OUTPUT=$(ctm config server:agents::get -s "$CONTROL_M_SERVER" 2>/dev/null)
    
    # Check if the command ran successfully
    if [ $? -ne 0 ]; then
        echo "Failed to fetch agents."
        exit 1
    fi

    # Filter for unavailable agents and store them in a variable
    UNAVAILABLE_AGENTS=$(echo "$AGENTS_OUTPUT" | jq -r '.[] | select(.status != "Available") | .name + ": " + .status')
    
    if [ -z "$UNAVAILABLE_AGENTS" ]; then
        echo "All agents are available."
        exit 0
    else
        echo "Unavailable agents found:"
        echo "$UNAVAILABLE_AGENTS"
    fi
}

# Function to send email
send_email() {
    # Send the email with list of unavailable agents
    echo -e "Subject: Control-M Unavailable Agents Report\n\nThe following agents are unavailable:\n\n$UNAVAILABLE_AGENTS" | sendmail -v "$EMAIL_RECIPIENT"
    
    if [ $? -eq 0 ]; then
        echo "Email sent successfully to $EMAIL_RECIPIENT."
    else
        echo "Failed to send email."
    fi
}

# Main script execution
fetch_unavailable_agents
send_email
